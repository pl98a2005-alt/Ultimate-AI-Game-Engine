name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Buildozer
        run: |
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Force Locate & Link SDK (Absolute Fix)
        run: |
          # البحث عن مكان الـ sdkmanager الحقيقي في السيرفر
          SDK_PATH=$(find $ANDROID_HOME -name "sdkmanager" | head -n 1)
          SDK_BIN_DIR=$(dirname "$SDK_PATH")
          
          echo "Found sdkmanager at: $SDK_PATH"
          
          # ربط المسار بالنظام لكي يراه بيلدوزر
          mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
          ln -s "$SDK_PATH" ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
          
          # قبول الرخص باستخدام المسار الكامل المكتشف
          yes | "$SDK_PATH" --sdk_root=$ANDROID_HOME --licenses || true

      - name: Generate Core Engine (Φ)
        run: |
          echo "from kivy.app import App; from kivy.uix.label import Label
          class SovereignApp(App):
              def build(self): return Label(text='Φ SYSTEM LIVE', font_size='50sp')
          SovereignApp().run()" > main.py

          echo "[app]
          title = Sovereign
          package.name = sovereign.phi
          package.domain = org.king
          source.dir = .
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2" > buildozer.spec

      - name: Start Final Build
        run: |
          # إجبار بيلدوزر على استخدام SDK النظام الجاهز
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          buildozer -v android debug

      - name: Capture Sovereign APK
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-Final-APK
          path: bin/*.apk
