name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install System Heavy Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk wget
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv

      - name: Manual SDK Injection (Force Fix)
        run: |
          # مسار بناء بيلدوزر الافتراضي
          export SDK_DIR=$HOME/.buildozer/android/platform/android-sdk
          mkdir -p $SDK_DIR/cmdline-tools
          
          # تحميل أدوات جوجل الرسمية يدوياً لكسر غباء المسارات
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip -d $SDK_DIR/cmdline-tools
          mv $SDK_DIR/cmdline-tools/cmdline-tools $SDK_DIR/cmdline-tools/latest
          
          # أهم خطوة: خداع بيلدوزر بعمل رابط وهمي للمسار الذي يبحث عنه
          mkdir -p $SDK_DIR/tools/bin
          ln -s $SDK_DIR/cmdline-tools/latest/bin/sdkmanager $SDK_DIR/tools/bin/sdkmanager
          
          # قبول الرخص فوراً قبل أن يبدأ أي شيء
          yes | $SDK_DIR/cmdline-tools/latest/bin/sdkmanager --sdk_root=$SDK_DIR --licenses

      - name: Generate Engine Files
        run: |
          echo "from kivy.app import App; from kivy.uix.label import Label
          class SovereignApp(App):
              def build(self): return Label(text='Φ READY')
          SovereignApp().run()" > main.py

          echo "[app]
          title = Sovereign
          package.name = sovereign.phi
          package.domain = org.king
          source.dir = .
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2" > buildozer.spec

      - name: Execute Sovereign Build
        run: |
          # إخبار بيلدوزر بمكان الـ SDK الذي جهزناه له
          /home/runner/.local/bin/buildozer -v android debug

      - name: Final Result
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-APK
          path: bin/*.apk
