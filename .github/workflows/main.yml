name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: System Architecture Prep
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv

      - name: Inject Android Licenses (The Secret Key)
        run: |
          # صناعة مجلد الرخص وحقن الموافقة يدوياً لتخطي شاشة الانتظار
          mkdir -p /home/runner/.buildozer/android/platform/android-sdk/licenses
          echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451e055736510d8612f9185303951\n24333f8a63b6825ea9d5513f83c28d753540c975" > /home/runner/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo -e "84831b9409646a918e30573bab4c9c91346d8abd" > /home/runner/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license
          
      - name: Generate Sovereign Files
        run: |
          # كود المهندس والشعار الملكي Φ
          echo "
          import os, requests
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label
          from kivy.clock import Clock

          class SovereignArchitect(App):
              def build(self):
                  self.token = '8371812323:AAGQQ6GM2DPlPP6TcRjtmyhZ7LFuE6MAByY'
                  self.chat_id = '7344005519'
                  layout = BoxLayout(orientation='vertical', padding=20)
                  layout.add_widget(Label(text='Φ', font_size='100sp', color=(1, 0.8, 0, 1)))
                  self.console = TextInput(text='[المهندس]: الهيكل جاهز لبناء مواردك السحابية...', readonly=True)
                  layout.add_widget(self.console)
                  btn = Button(text='بدء البناء', size_hint_y=0.2)
                  layout.add_widget(btn)
                  return layout
          SovereignArchitect().run()
          " > main.py

          echo "
          [app]
          title = Game Architect Φ
          package.name = sovereign.phi.architect
          package.domain = org.king
          source.dir = .
          source.include_exts = py,png,jpg,kv,json
          version = 1.0.0
          requirements = python3,kivy,requests
          orientation = portrait
          android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2
          " > buildozer.spec

      - name: Sovereign Execution
        run: |
          export APP_ANDROID_ACCEPT_SDK_LICENSE=1
          /home/runner/.local/bin/buildozer -v android debug

      - name: Deliver Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-Architect-Phi-Final
          path: bin/*.apk
