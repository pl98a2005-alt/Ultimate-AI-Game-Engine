name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Infrastructure & SDK Fix
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv
          
          # تحميل أدوات سطر الأوامر يدويًا لضمان وجود sdkmanager في المسار الصحيح
          mkdir -p ~/.buildozer/android/platform/android-sdk/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip commandlinetools-linux-9477386_latest.zip -d ~/.buildozer/android/platform/android-sdk/cmdline-tools
          mv ~/.buildozer/android/platform/android-sdk/cmdline-tools/cmdline-tools ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest
          
          # إنشاء روابط رمزية (Symlinks) للمسارات القديمة التي يبحث عنها buildozer
          mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
          ln -s ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager

      - name: Force Sovereign Licenses
        run: |
          # حقن الرخص في كل مكان ممكن
          mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
          yes | ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/home/runner/.buildozer/android/platform/android-sdk --licenses || true

      - name: Generate Core Files (Φ)
        run: |
          echo "
          from kivy.app import App
          from kivy.uix.label import Label
          class SovereignApp(App):
              def build(self):
                  return Label(text='Φ\nSYSTEM READY', font_size='80sp', color=(1, 0.8, 0, 1))
          SovereignApp().run()
          " > main.py

          echo "
          [app]
          title = Sovereign Architect
          package.name = sovereign.phi.architect
          package.domain = org.king
          source.dir = .
          source.include_exts = py,png,jpg,kv,json
          version = 1.1.0
          requirements = python3,kivy
          orientation = portrait
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2
          " > buildozer.spec

      - name: Final Execution
        run: |
          export PATH=$PATH:~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin
          /home/runner/.local/bin/buildozer -v android debug

      - name: Deliver Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-Architect-Success
          path: bin/*.apk
