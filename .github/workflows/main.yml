name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: System Pre-Configuration
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv

      - name: Force Accept Android Licenses
        run: |
          # تثبيت أدوات الرخص وقبولها آلياً قبل بدء البناء
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses || true

      - name: Generate Sovereign Core
        run: |
          # إنشاء الملفات الملكية بشعار Φ
          echo "
          import os, json, requests
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label
          from kivy.core.window import Window
          from kivy.clock import Clock

          Window.clearcolor = (0.01, 0.01, 0.01, 1)

          class SovereignArchitect(App):
              def build(self):
                  self.token = '8371812323:AAGQQ6GM2DPlPP6TcRjtmyhZ7LFuE6MAByY'
                  self.chat_id = '7344005519'
                  layout = BoxLayout(orientation='vertical', padding=25, spacing=15)
                  self.logo = Label(text='Φ', font_size='100sp', color=(1, 0.8, 0, 1), size_hint_y=0.2)
                  self.console = TextInput(text='[المهندس]: نظام الخبرة نشط. سأبني لك هيكلاً صغيراً وموارد سحابية...', 
                                          readonly=True, background_color=(0.05, 0.05, 0.05, 1), 
                                          foreground_color=(0, 1, 0, 1))
                  self.user_input = TextInput(hint_text='اصف لعبتك هنا...', multiline=True, size_hint_y=0.3)
                  self.timer_label = Label(text='الوقت المتبقي: 00:00', color=(0.8, 0.8, 0.8, 1))
                  build_btn = Button(text='بدء البناء السيادي', background_color=(0, 0.5, 0.8, 1), size_hint_y=0.15)
                  build_btn.bind(on_release=self.start_logic)
                  layout.add_widget(self.logo); layout.add_widget(self.console); layout.add_widget(self.timer_label)
                  layout.add_widget(self.user_input); layout.add_widget(build_btn)
                  return layout

              def start_logic(self, instance):
                  self.console.text += '\n[تحليل]: جاري تقسيم الموارد APK+OBB لتوفير المساحة...'
                  self.remaining_time = 3600
                  Clock.schedule_interval(self.update_timer, 1)

              def update_timer(self, dt):
                  if self.remaining_time > 0:
                      self.remaining_time -= 1
                      mins, secs = divmod(self.remaining_time, 60)
                      self.timer_label.text = f'الوقت المتبقي: {mins:02d}:{secs:02d}'
                  else:
                      self.timer_label.text = '✅ اكتمل! أرسلت الرابط لتليجرام.'
                      return False
          SovereignArchitect().run()
          " > main.py

          echo "
          [app]
          title = Game Architect Φ
          package.name = sovereign.phi.architect
          package.domain = org.king
          source.dir = .
          source.include_exts = py,png,jpg,kv,json
          version = 1.0.0
          requirements = python3,kivy,requests
          orientation = portrait
          android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE
          android.accept_sdk_license = True
          android.archs = arm64-v8a
          android.api = 31
          android.minapi = 21
          log_level = 2
          " > buildozer.spec

      - name: Execution
        run: |
          export APP_ANDROID_ACCEPT_SDK_LICENSE=1
          /home/runner/.local/bin/buildozer -v android debug

      - name: Deliver Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-Architect-Phi-Final
          path: bin/*.apk
