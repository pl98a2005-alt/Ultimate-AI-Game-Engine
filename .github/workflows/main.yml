name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: System Infrastructure
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv

      - name: Create Sovereign Directories & Permissions
        run: |
          # تجهيز المجلدات قبل بدء Buildozer
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          # الموافقة على رخص أندرويد بشكل استباقي وشامل
          yes | sdkmanager --licenses || true

      - name: Generate Sovereign Files
        run: |
          # إنشاء ملف main.py (واجهة المهندس Φ)
          echo "
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label
          from kivy.core.window import Window

          Window.clearcolor = (0.01, 0.01, 0.01, 1)

          class SovereignArchitect(App):
              def build(self):
                  layout = BoxLayout(orientation='vertical', padding=20, spacing=10)
                  layout.add_widget(Label(text='Φ', font_size='100sp', color=(1, 0.8, 0, 1)))
                  self.console = TextInput(text='[المهندس]: نظام الهيكل الصغير نشط. جاري تجهيز بيئة الموارد...', readonly=True)
                  layout.add_widget(self.console)
                  btn = Button(text='بدء البناء الملكي', background_color=(0, 0.5, 0.8, 1))
                  layout.add_widget(btn)
                  return layout
          SovereignArchitect().run()
          " > main.py

          # إنشاء ملف buildozer.spec (تصحيح مسارات الأدوات)
          echo "
          [app]
          title = Architect Φ
          package.name = sovereign.phi.architect
          package.domain = org.king
          source.dir = .
          source.include_exts = py,png,jpg,kv,json
          version = 1.0.0
          requirements = python3,kivy,requests
          orientation = portrait
          android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2
          # تفعيل نظام التحميل الداخلي لتقليل حجم الـ APK
          android.copy_libs = 1
          " > buildozer.spec

      - name: Build With Auto-Repair
        run: |
          export APP_ANDROID_ACCEPT_SDK_LICENSE=1
          # الأمر التالي سيحاول البناء، وإذا فقد الـ sdkmanager سيقوم Buildozer بتحميله تلقائياً في المكان الصحيح
          /home/runner/.local/bin/buildozer -v android debug

      - name: Deliver Final APK
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-Architect-Phi-App
          path: bin/*.apk
