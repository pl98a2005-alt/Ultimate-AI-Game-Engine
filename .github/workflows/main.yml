name: BUILD_SOVEREIGN_FACTORY
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev zip unzip libffi-dev libssl-dev openjdk-17-jdk
          pip install --user --upgrade Cython==0.29.33 buildozer virtualenv

      - name: Prepare Sovereign Files
        run: |
          echo "from kivy.app import App; from kivy.uix.label import Label
          class SovereignApp(App):
              def build(self): return Label(text='Φ SYSTEM ACTIVE')
          SovereignApp().run()" > main.py

          echo "[app]
          title = Sovereign Architect
          package.name = sovereign.phi.architect
          package.domain = org.king
          source.dir = .
          version = 1.1.0
          requirements = python3,kivy
          orientation = portrait
          android.accept_sdk_license = True
          android.api = 31
          android.minapi = 21
          android.archs = arm64-v8a
          log_level = 2" > buildozer.spec

      - name: Build with Auto-Accept
        run: |
          # هذه الخطوة تضمن قبول الرخص حتى لو فُقد الكاش
          mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
          printf "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451e055736510d8612f9185303951" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          yes | /home/runner/.local/bin/buildozer -v android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Sovereign-App
          path: bin/*.apk
